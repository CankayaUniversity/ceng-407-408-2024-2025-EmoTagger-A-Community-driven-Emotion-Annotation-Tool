@model EmoTagger.ViewModels.HomeViewModel
@{
    ViewData["Title"] = "Ana Sayfa";
}

<link rel="stylesheet" href="~/css/home.css">



<!-- Ã–ne Ã‡Ä±kan BÃ¶lÃ¼m -->
<div class="highlighted-section">
    <div class="content">
        <h2>Discover the Emotions of Music</h2>
        <p>Choose from thousands of songs tagged by musical mood.</p>
        <a asp-controller="Dashboard" asp-action="ListenTag" class="btn btn-discover">Discover <i class="fas fa-arrow-right ms-2"></i></a>
    </div>
    <div class="image">
       
    </div>
</div>

<!-- Duygu Kategorileri -->
<div class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="section-title">Emotion Collections</h3>
       
    </div>

    <div class="row">
        @foreach (var category in Model.EmotionCategories)
        {
            <div class="col-lg-4 col-md-6">
                <div class="category-card" data-tag="@category.Tag">
                    <div class="category-overlay"></div>
                    <img src="~/assets/images/categories/@(category.Tag.ToLower()).jpg" alt="@category.Tag">
                    <div class="category-content">
                        <div class="emoji">@GetEmoji(category.Tag)</div>
                        <div class="category-title">@category.Tag</div>
                        <div class="category-count">@category.SongCount ÅŸarkÄ±</div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Kategoriye GÃ¶re ÅžarkÄ±lar (Dinamik olarak JavaScript ile yÃ¼klenecek) -->
<!-- Kategoriye GÃ¶re ÅžarkÄ±lar (Dinamik olarak JavaScript ile yÃ¼klenecek) -->
<div id="category-music-section" class="mb-5 d-none">
    <h3 class="section-title category-title">
        <span class="category-emoji"></span>
        <span class="category-name"></span>
    </h3>
    <div id="category-music-container" class="category-container">
        <!-- Kategoriye gÃ¶re ÅŸarkÄ±lar burada gÃ¶sterilecek (yatay kaydÄ±rmalÄ±) -->
    </div>
</div>




@functions {
    public string GetEmoji(string tag)
    {
        return tag.ToLower() switch
        {
            "sad" => "ðŸ˜¢",
            "happy" => "ðŸ˜„",
            "nostalgic" => "ðŸŒ§ï¸",
            "energetic" => "ðŸ”¥",
            "relaxing" => "ðŸ§˜",
            "romantic" => "â¤ï¸",
            _ => "ðŸŽµ"
        };
    }

    public string FormatNumber(int number)
    {
        if (number < 1000) return number.ToString();
        if (number < 10000) return Math.Round(number / 1000.0, 1) + "k";
        return (number / 1000) + "k";
    }
}

@section Scripts {
    <script>

             // Sayfa yÃ¼klendiÄŸinde
        document.addEventListener('DOMContentLoaded', function() {
            // Otomatik sayfa yenileme varsa durdur
            preventPageRefresh();
            sessionStorage.clear(); // tÃ¼m eski verileri uÃ§ur

            // Logo yazÄ±sÄ±nÄ± gizle (sol Ã¼stteki siyah yazÄ±)
            hideLogo();

            // Kategori yazÄ±larÄ±nÄ± ortala
            centerCategoryContent();

            // Kategorileri yÃ¼kle ve gÃ¼ncelle - sayÄ±larÄ±n doÄŸru gelmesi iÃ§in
            loadCategoriesForHomepage();

            // Kategori kartlarÄ±na tÄ±klama olayÄ±
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', function() {
                    const tag = this.getAttribute('data-tag');
                    if (tag) {
                        // TÄ±klandÄ±ÄŸÄ±nda animasyon efekti
                        this.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.style.transform = 'translateY(-5px)';
                            // Titreme Ã§Ã¶zÃ¼mÃ¼ ile kategori ÅŸarkÄ±larÄ±nÄ± yÃ¼kle
                            loadCategoryMusicWithoutFlicker(tag);
                        }, 150);
                    }
                });

                // Hover efektlerini iyileÅŸtir
                card.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.transform = 'translateY(-8px)';
                        this.style.boxShadow = '0 15px 25px rgba(0,0,0,0.2)';
                    }
                });

                card.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.transform = '';
                        this.style.boxShadow = '';
                    }
                });
            });

            // LocalStorage'dan seÃ§ili kategoriyi kontrol et
            const selectedCategory = localStorage.getItem('selectedCategory');
            if (selectedCategory) {
                // KÄ±sa bir sÃ¼re bekleyerek sayfanÄ±n tam yÃ¼klenmesini saÄŸla
                setTimeout(() => {
                    loadCategoryMusicWithoutFlicker(selectedCategory);
                    // SeÃ§ili kategoriyi temizle
                    localStorage.removeItem('selectedCategory');
                }, 500);
            }
        });

        // Otomatik sayfa yenilemesini tamamen durdur
        function preventPageRefresh() {
            // 1. TÃ¼m mevcut zamanlayÄ±cÄ±larÄ± temizle
            for (let i = 1; i < 10000; i++) {
                window.clearTimeout(i);
                window.clearInterval(i);
            }

            // 2. History API'sini deÄŸiÅŸtir
            const originalPushState = history.pushState;
            history.pushState = function() {
                return originalPushState.apply(this, arguments);
            };

            // 3. window.location.reload'u devre dÄ±ÅŸÄ± bÄ±rak
            window.location.reload = function() {
                console.log("Sayfa yenileme engellendi");
                return false;
            };

            // 4. FormlarÄ±n submit olayÄ±nÄ± engelle
            document.addEventListener('submit', function(e) {
                e.preventDefault();
                return false;
            }, true);

            // 5. BaÄŸlantÄ±larÄ±n tÄ±klama olayÄ±nÄ± izle
            document.addEventListener('click', function(e) {
                const link = e.target.closest('a');
                if (link && link.getAttribute('href') === '#') {
                    e.preventDefault();
                }
            }, true);

            console.log("TÃ¼m sayfa yenileme mekanizmalarÄ± devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±");
        }

        // Logo yazÄ±sÄ±nÄ± gizle
        function hideLogo() {
            // Sol Ã¼stteki siyah yazÄ±yÄ± gizle - CSS kullanamadÄ±ÄŸÄ±mÄ±z iÃ§in JS ile yapÄ±yoruz
            const logoElements = document.querySelectorAll('.tagger, .music-logo-text, .app-title, .app-logo-text');
            logoElements.forEach(el => {
                if (el) el.style.display = 'none';
            });

            // AyrÄ±ca mÃ¼zik simgesi iÃ§in Ã¶zel stil
            const musicIcon = document.querySelector('.music-logo-icon, .app-logo-icon');
            if (musicIcon) {
                musicIcon.style.fontSize = '32px';
                musicIcon.style.color = '#ff5252';
                musicIcon.style.marginRight = '5px';
            }
        }

        // Kategori iÃ§eriÄŸini ortala
        function centerCategoryContent() {
            // TÃ¼m kategori kartlarÄ±ndaki iÃ§eriÄŸi ortala
            document.querySelectorAll('.category-content').forEach(content => {
                content.style.display = 'flex';
                content.style.flexDirection = 'column';
                content.style.justifyContent = 'center';
                content.style.alignItems = 'center';
                content.style.height = '100%';
                content.style.top = '0';
                content.style.padding = '20px';
            });

            // Emoji boyutunu artÄ±r
            document.querySelectorAll('.category-content .emoji').forEach(emoji => {
                emoji.style.fontSize = '48px';
                emoji.style.marginBottom = '10px';
            });

            // Kategori baÅŸlÄ±ÄŸÄ±nÄ± bÃ¼yÃ¼t
            document.querySelectorAll('.category-content .category-title').forEach(title => {
                title.style.fontSize = '32px';
                title.style.fontWeight = 'bold';
                title.style.marginBottom = '8px';
            });
        }

        // ÅžarkÄ± Ã§alma fonksiyonu
        function playMusic(src, title, element) {
            const audio = document.getElementById("musicPlayer");
            if (!audio) return;

            // MusicID'yi al
            const musicId = element.getAttribute('data-music-id') ||
                            element.closest('[data-music-id]')?.getAttribute('data-music-id');

            // MÃ¼zik URL'ini oluÅŸtur
            const musicUrl = `https://emomusicc.vercel.app/music/${encodeURIComponent(src)}`;

            // localStorage'a son oynatÄ±lanÄ± kaydet
            localStorage.setItem("lastPlayedSrc", musicUrl);
            localStorage.setItem("lastPlayedTitle", title);

            // Stil
            document.querySelectorAll('.track-card, .trending-track, .carousel-item').forEach(item => {
                item.classList.remove('playing-now');
            });

            if (element) {
                element.classList.add('playing-now');
            }

            // Global deÄŸiÅŸkenleri ayarla
            const titleParts = title.split(' - ');
            window.currentTrackTitle = titleParts[0];
            window.currentTrackArtist = titleParts.length > 1 ? titleParts[1] : '';
            window.currentMusicId = musicId;

            // Oynat
            audio.src = musicUrl;
            audio.play().catch(e => console.warn("Otomatik oynatma engellendi:", e));

            document.title = title + " ðŸŽµ";

            const marquee = document.querySelector('.marquee-content');
            if (marquee) {
                marquee.innerHTML = `<strong>${title}</strong>`;
            }

            // Ã–zel event tetikle - diÄŸer bileÅŸenlerle iletiÅŸim iÃ§in
            document.dispatchEvent(new CustomEvent('songChanged', {
                detail: {
                    id: window.currentMusicId,
                    title: window.currentTrackTitle,
                    artist: window.currentTrackArtist
                }
            }));
        }

               function loadCategoriesForHomepage() {
            fetch('/Tag/GetAllCategories?ts=' + new Date().getTime(), {
                cache: "no-store"
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.categories && data.categories.length > 0) {
                        const categoryUpdates = {};
                        data.categories.forEach(category => {
                            categoryUpdates[category.tag.toLowerCase()] = category.songCount;
                        });

                        document.querySelectorAll('.category-card').forEach(card => {
                            const tag = card.getAttribute('data-tag').toLowerCase();
                            if (categoryUpdates[tag]) {
                                const countEl = card.querySelector('.category-count');
                                if (countEl) {
                                    countEl.textContent = `${categoryUpdates[tag]} ÅŸarkÄ±`;
                                }
                            }
                        });

                        console.log("Kategori sayÄ±larÄ± gÃ¼ncellendi");
                    }
                })
                .catch(err => console.error("Kategori listesi alÄ±nÄ±rken hata:", err));
                bindCategoryCardEvents(); // GÃ¼ncellenen kartlara tekrar tÄ±klama olayÄ± ekle

        }


        // Titreme olmadan kategori ÅŸarkÄ±larÄ±nÄ± yÃ¼kle
        function loadCategoryMusicWithoutFlicker(tag) {
            // SeÃ§ilen kategoriyi vurgula
            highlightSelectedCategory(tag);

            // Kategori bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶ster
            const categorySection = document.getElementById('category-music-section');
            categorySection.classList.remove('d-none');

            // BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
            const categoryTitle = categorySection.querySelector('.category-title');
            const categoryEmoji = categoryTitle.querySelector('.category-emoji');
            const categoryName = categoryTitle.querySelector('.category-name');

            categoryEmoji.textContent = getEmoji(tag);
            categoryName.textContent = tag + ' ÅžarkÄ±larÄ±';

            // ÅžarkÄ± konteyneri
            const container = document.getElementById('category-music-container');

            // YÃ¼kleme gÃ¶stergesi
            if (container) {
                container.innerHTML = `
                    <div class="text-center p-5">
                        <div class="spinner-border" role="status"></div>
                        <p class="mt-3">ÅžarkÄ±lar yÃ¼kleniyor...</p>
                    </div>
                `;
            }

            // MÃ¼zikleri getir
            fetch(`/Tag/GetMusicByCategory?category=${tag}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.songs && data.songs.length > 0) {
                        // Yeni titreme olmayan metod ile ÅŸarkÄ±larÄ± gÃ¶ster
                        displayCategoryMusicWithoutFlicker(data.songs, tag);
                    } else {
                        // SonuÃ§ yoksa bilgi ver
                        if (container) {
                            container.innerHTML = `
                                <div class="alert alert-info text-center py-4">
                                    "${tag}" kategorisinde henÃ¼z ÅŸarkÄ± bulunmuyor.
                                </div>
                            `;
                        }
                    }
                })
                .catch(err => {
                    console.error("Kategori mÃ¼zikleri alÄ±nÄ±rken hata:", err);
                    if (container) {
                        container.innerHTML = `
                            <div class="alert alert-danger text-center py-4">
                                MÃ¼zikler yÃ¼klenirken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.
                            </div>
                        `;
                    }
                });

            // Kategori bÃ¶lÃ¼mÃ¼ne yumuÅŸak kaydÄ±rma
            categorySection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

           // Kategori mÃ¼ziklerini titreme olmadan gÃ¶ster (yatay kaydÄ±rmalÄ± versiyon)
        function displayCategoryMusicWithoutFlicker(songs, categoryName) {
            const container = document.getElementById('category-music-container');
            if (!container) return;

            // SayfayÄ± sabit tut
            container.style.height = Math.max(container.offsetHeight, 400) + 'px';
            container.style.opacity = '0';

            // Kategori rengini belirle
            const categoryColor = getCategoryColor(categoryName);

            // --- ÅžarkÄ± listesini global deÄŸiÅŸkene ata ---
            window.currentCategorySongs = songs.map(song => ({
                id: song.musicId,
                title: song.title,
                artist: song.artist,
                filename: song.filename
            }));

            // Ä°Ã§eriÄŸi hazÄ±rla - Yatay kaydÄ±rmalÄ± yapÄ±
            let html = `
                <div class="w-100 mb-4">
                    <button class="btn btn-success" onclick="playRandomSong()">
                        <i class="fas fa-random mr-2"></i> KarÄ±ÅŸÄ±k Ã‡al
                    </button>
                </div>
                <div class="position-relative songs-scroll-container">
                    <!-- Sol kaydÄ±rma oku -->
                    <button class="scroll-arrow scroll-left" onclick="scrollSongs('left')">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <!-- Yatay kaydÄ±rmalÄ± ÅŸarkÄ± listesi -->
                    <div class="songs-scroll" id="songs-scroll-${categoryName.toLowerCase()}">
            `;

            songs.forEach(song => {
                html += `
                    <div class="track-card song-card"
                         data-music-id="${song.musicId}"
                         data-filename="${song.filename}"
                         style="background: linear-gradient(135deg, ${categoryColor}, ${getLighterColor(categoryColor)})">
                        <div class="track-info">
                            <div class="track-title">${song.title}</div>
                            <div class="track-artist">${song.artist}</div>
                            <div class="track-tags">
                                <span class="tag-badge ${categoryName.toLowerCase()}">${categoryName}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>

                    <!-- SaÄŸ kaydÄ±rma oku -->
                    <button class="scroll-arrow scroll-right" onclick="scrollSongs('right')">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;

            // Tek seferde DOM'a ekle
            container.innerHTML = html;

            // ÅžarkÄ± kartlarÄ±na tÄ±klama olaylarÄ±
            container.querySelectorAll('.track-card').forEach(card => {
                card.addEventListener('click', function() {
                    const musicId = this.getAttribute('data-music-id');
                    const filename = this.getAttribute('data-filename');
                    const title = this.querySelector('.track-title').textContent;
                    const artist = this.querySelector('.track-artist').textContent;

                    playMusic(filename, `${title} - ${artist}`, this);
                });
            });

            // Ã‡alan ÅŸarkÄ±yÄ± vurgula
            if (window.currentMusicId) {
                const playingCard = container.querySelector(`.track-card[data-music-id="${window.currentMusicId}"]`);
                if (playingCard) {
                    playingCard.classList.add('playing-now');
                }
            }

            // Stabilize et ve gÃ¶ster
            setTimeout(() => {
                container.style.height = 'auto';
                container.style.opacity = '1';
                container.style.transition = 'opacity 0.3s ease';
            }, 50);
        }

        // ÅžarkÄ±larÄ± kaydÄ±rma fonksiyonu
        function scrollSongs(direction) {
            const currentCategoryName = document.querySelector('.category-title .category-name').textContent.split(' ')[0];
            const scrollContainer = document.getElementById(`songs-scroll-${currentCategoryName.toLowerCase()}`);

            if (!scrollContainer) return;

            const scrollAmount = 300; // her tÄ±klamada kaydÄ±rma miktarÄ±

            if (direction === 'left') {
                scrollContainer.scrollBy({
                    left: -scrollAmount,
                    behavior: 'smooth'
                });
            } else {
                scrollContainer.scrollBy({
                    left: scrollAmount,
                    behavior: 'smooth'
                });
            }
        }

        // Kategori rengini al
        function getCategoryColor(categoryName) {
            switch(categoryName.toLowerCase()) {
                case 'sad': return '#6a5acd';
                case 'happy': return '#ffa500';
                case 'nostalgic': return '#9400d3';
                case 'energetic': return '#ff1493';
                case 'relaxing': return '#40e0d0';
                case 'romantic': return '#ff69b4';
                default: return '#3498db';
            }
        }

        // Daha aÃ§Ä±k renk oluÅŸtur (gradient iÃ§in)
        function getLighterColor(hexColor) {
            // Hex rengi RGB'ye Ã§evir
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);

            // Daha aÃ§Ä±k renk oluÅŸtur
            const lighterR = Math.min(255, r + 50);
            const lighterG = Math.min(255, g + 50);
            const lighterB = Math.min(255, b + 50);

            // RGB'yi hex'e Ã§evir
            return `#${lighterR.toString(16).padStart(2, '0')}${lighterG.toString(16).padStart(2, '0')}${lighterB.toString(16).padStart(2, '0')}`;
        }

        // KarÄ±ÅŸÄ±k ÅŸarkÄ± Ã§alma fonksiyonu
        function playRandomSong() {
            const songs = window.currentCategorySongs;
            if (!songs || songs.length === 0) return;

            // KarÄ±ÅŸÄ±k sÄ±raya sok
            const shuffled = songs.slice().sort(() => Math.random() - 0.5);
            if (typeof window.setFooterPlaylist === 'function') {
                window.setFooterPlaylist(shuffled, 0); // 0. ÅŸarkÄ±dan baÅŸla
            }
        }

        // SeÃ§ilen kategoriyi vurgula
        function highlightSelectedCategory(tag) {
            // TÃ¼m kategorilerden vurguyu kaldÄ±r
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('selected');
                card.style.transform = '';
                card.style.boxShadow = '';
            });

            // SeÃ§ilen kategoriye vurgu ekle
            const selectedCard = document.querySelector(`.category-card[data-tag="${tag}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                selectedCard.style.transform = 'translateY(-5px)';
                selectedCard.style.boxShadow = '0 10px 20px rgba(0,0,0,0.2)';
            }
        }

        // Emoji fonksiyonu - View'daki GetEmoji ile aynÄ±
        function getEmoji(tag) {
            switch(tag.toLowerCase()) {
                case 'sad': return 'ðŸ˜¢';
                case 'happy': return 'ðŸ˜„';
                case 'nostalgic': return 'ðŸŒ§ï¸';
                case 'energetic': return 'ðŸ”¥';
                case 'relaxing': return 'ðŸ§˜';
                case 'romantic': return 'â¤ï¸';
                default: return 'ðŸŽµ';
            }
        }
                document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && (link.getAttribute('href') === '/' || link.getAttribute('asp-controller') === 'Home')) {
                // Home'a tÄ±klanÄ±nca anÄ±nda loading gÃ¶ster
                document.querySelectorAll('.category-card .category-count').forEach(el => {
                    el.textContent = 'YÃ¼kleniyor...';
                });
                setTimeout(() => {
                    loadCategoriesForHomepage(); // Home'a bastÄ±ktan sonra sayÄ±larÄ± tekrar getir
                }, 100); // Ã§ok kÃ¼Ã§Ã¼k delay, sayfa yÃ¼klemesini bekliyoruz
            }
        });
                document.addEventListener('DOMContentLoaded', function () {
            const homeLink = document.getElementById('home-link');
            if (homeLink) {
                homeLink.addEventListener('click', function () {
                    setTimeout(() => {
                        loadCategoriesForHomepage(); // yeniden kategori sayÄ±larÄ±nÄ± yÃ¼kle
                    }, 200); // sayfa yÃ¼klenmesini bekleyerek Ã§aÄŸÄ±r
                });
            }
        });
                function bindCategoryCardEvents() {
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', function () {
                    const tag = this.getAttribute('data-tag');
                    if (tag) {
                        this.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.style.transform = 'translateY(-5px)';
                            loadCategoryMusicWithoutFlicker(tag);
                        }, 150);
                    }
                });

                card.addEventListener('mouseenter', function () {
                    if (!this.classList.contains('selected')) {
                        this.style.transform = 'translateY(-8px)';
                        this.style.boxShadow = '0 15px 25px rgba(0,0,0,0.2)';
                    }
                });

                card.addEventListener('mouseleave', function () {
                    if (!this.classList.contains('selected')) {
                        this.style.transform = '';
                        this.style.boxShadow = '';
                    }
                });
            });
        }

    </script>
}