@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Dinleme Geçmişi";
}
<link rel="stylesheet" href="~/css/listeninghistory.css">
<!doctype html>
<html lang="tr" dir="ltr">
<head>
    <style>

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }

            .pagination .page-item {
                list-style: none;
            }

            .pagination .page-link {
                padding: 8px 16px;
                text-decoration: none;
                border-radius: 4px;
                background-color: #ff4c4c;
                color: #fff;
                font-weight: bold;
            }

            .pagination .page-item.active .page-link {
                background-color: #cc0000;
                color: white;
            }

            .pagination .page-link:hover {
                background-color: #ff9999;
            }

        .table th, .table td {
            vertical-align: middle;
        }

        .no-data-message {
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: #666;
        }

        .loading-spinner {
            text-align: center;
            padding: 20px;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

            .page-size-selector select {
                margin-left: 10px;
                padding: 5px;
                border-radius: 4px;
                border: 1px solid #ccc;
            }
    </style>
</head>
<body>
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title">Dinleme Geçmişi</h4>
                    <div class="page-size-selector">
                        <label for="pageSize">Sayfa başına:</label>
                        <select id="pageSize" class="form-select form-select-sm">
                            <option value="3">3</option>
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
                <div class="card-body px-0">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th scope="col">No.</th>
                                    <th scope="col">Şarkı</th>
                                    <th scope="col">Sanatçı</th>
                                    <th scope="col">Dinlenme Zamanı</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="4" class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Yükleniyor...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center px-3 mt-3">
                        <div id="pageInfo"></div>
                        <ul class="pagination" id="pagination"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let pageSize = localStorage.getItem("pageSize") ? parseInt(localStorage.getItem("pageSize")) : 20;

        const historyTableBody = document.getElementById('historyTableBody');
        const pagination = document.getElementById('pagination');
        const pageInfo = document.getElementById('pageInfo');
        const pageSizeSelector = document.getElementById('pageSize');

        // Sayfa yüklendiğinde seçimi ayarla
        document.addEventListener("DOMContentLoaded", () => {
            pageSizeSelector.value = pageSize;
            loadHistory();
        });

        // Sayfa başına değişince
        pageSizeSelector.addEventListener('change', function () {
            pageSize = parseInt(this.value);
            localStorage.setItem("pageSize", pageSize); // Seçimi sakla
            currentPage = 1;
            loadHistory();
        });

        function loadHistory() {
            historyTableBody.innerHTML = `<tr><td colspan="4" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Yükleniyor...</span>
                </div>
            </td></tr>`;

            fetch(`/Dashboard/GetHistory?page=${currentPage}&pageSize=${pageSize}`)
                .then(response => response.json())
                .then(data => {
                    if (!data || !data.played || data.played.length === 0) {
                        historyTableBody.innerHTML = '<tr><td colspan="4" class="no-data-message">Henüz şarkı dinlenmedi.</td></tr>';
                        return;
                    }

                    data.played.sort((a, b) => new Date(b.playedAt) - new Date(a.playedAt));
                    const totalItems = data.played.length;
                    totalPages = Math.ceil(totalItems / pageSize);
                    const start = (currentPage - 1) * pageSize;
                    const end = start + pageSize;
                    const items = data.played.slice(start, end);

                    renderTable(items, start);
                    renderPagination();
                    updatePageInfo();
                })
                .catch(() => {
                    historyTableBody.innerHTML = '<tr><td colspan="4" class="no-data-message">Veriler yüklenirken hata oluştu</td></tr>';
                });
        }

        function renderTable(items, startIndex) {
            let html = '';
            items.forEach((item, index) => {
                html += `
                <tr>
                    <td>${startIndex + index + 1}</td>
                    <td><p class="mb-0">${item.title || 'Başlık Yok'}</p></td>
                    <td><p class="mb-0">${item.artist || 'Sanatçı Yok'}</p></td>
                    <td><p class="mb-0">${item.playedAt || ''}</p></td>
                </tr>
                `;
            });
            historyTableBody.innerHTML = html;
        }

        function renderPagination() {
            let html = '';
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="javascript:void(0);" onclick="changePage(${currentPage - 1})">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                     </li>`;
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="javascript:void(0);" onclick="changePage(${i})">${i}</a>
                         </li>`;
            }
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="javascript:void(0);" onclick="changePage(${currentPage + 1})">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                     </li>`;
            pagination.innerHTML = html;
        }

        function updatePageInfo() {
            pageInfo.textContent = `Sayfa ${currentPage} / ${totalPages}`;
        }

        function changePage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            loadHistory();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>

</body>
</html>